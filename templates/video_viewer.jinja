<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Éditeur de sous-titres</title>
    <style>
        body { height: 100vh; margin: 0; overflow: hidden; }
        #container { display: flex; width: 100%; margin-top: 40px; }
        #video-container { width: 60%; display: flex; flex-direction: column; align-items: center; }
        video { width: 100%; max-width: 720px; }
        .subtitle { padding: 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
        .active { background-color: yellow; }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        .controls button { font-size: 16px; padding: 5px 10px; cursor: pointer; }
        .controls img { width: 24px; height: 24px; }
        #current-subtitle { margin-top: 10px; font-size: 18px; font-weight: bold; }
        .tabs { display: flex; gap: 10px; margin-bottom: 10px; }
        .tab { padding: 5px 10px; cursor: pointer; border: 1px solid #ddd; }
        .tab.active { background-color: lightgray; }
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 40px; /* Ajuste selon ta div */
            background: white; /* Ajoute un fond si besoin */
            z-index: 1000; /* Pour s'assurer qu'elle est au-dessus des autres éléments */
        } 

        #subtitles {
            width: 40%;
            scroll-padding-top: 80px;
            border-right: 2px solid #ccc;
            text-align: center;
            margin-top: 10px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            width: 80%;
        }

        #subtitles, #video-container {
            max-height: calc(100vh - 80px); /* Ajuste la hauteur en soustrayant la barre du haut */
            overflow-y: auto;
        }

        #video-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        .tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

 
        #container {
            display: flex;
            width: 100%;
            margin-top: 40px;
        }

        #subtitles-container {
            width: 40%;
            max-height: calc(100vh - 80px);
            overflow-y: auto;
            padding: 10px;
            border-right: 2px solid #ccc;
        }

        #video-container {
            width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        video {
            width: 100%;
            max-width: 720px;
        }

        .subtitle {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        .active {
            background-color: yellow;
        }

        .tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        #current-subtitle {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            min-height: 30px;
        }
        #current-subtitle {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .sub-box {
            width: 50%;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            min-height: 30px;
        }

    </style>
</head>
<body>
    <div id="top-bar">
        <button id="save-all">Tout Sauver</button>
        <input type="number" id="subtitle-number" placeholder="Numéro">
        <button id="go-to-subtitle">Aller</button>
    </div>

    <div id="container">
        <!-- Liste des sous-titres à gauche -->
        <div id="subtitles-container">
            <div id="subtitles"></div>
        </div>

        <!-- Vidéo + onglets sous la vidéo -->
        <div id="video-container">
            <video id="video" controls>
                <source src="/simple-video.mp4" type="video/mp4">
                <track src="subtitles.srt" kind="subtitles" srclang="fr" label="Français" default>
            </video>
            <div class="controls">
                <button onclick="prevSubtitle()">
                    <img src="{{ url_for('static', path='/icons/step-backward.svg') }}" alt="Backward">
                </button>
                <button onclick="video.pause()">
                    <img src="{{ url_for('static', path='/icons/pause.svg') }}" alt="Pause">
                </button>
                <button onclick="playVideo()">
                    <img src="{{ url_for('static', path='/icons/play.svg') }}" alt="Play">
                </button>
                <button onclick="replaySubtitle()">
                    <img src="{{ url_for('static', path='/icons/replay.svg') }}" alt="Replay">
                </button>
                <button onclick="nextSubtitle()">
                    <img src="{{ url_for('static', path='/icons/step-forward.svg') }}" alt="Forward">
                </button>
            </div>

            <!-- Onglets sous la vidéo -->
            <div class="tabs">
                <div class="tab active" data-type="es">ES</div>
                <div class="tab" data-type="fr">FR</div>
                <div class="tab" data-type="esfr">ES + FR</div>
                <div class="tab" data-type="eslong">ES Long</div>
                <div class="tab" data-type="frlong">FR Long</div>
                <div class="tab" data-type="esfrlong">ES + FR Long</div>
            </div>

                        <!-- Uniquement le sous-titre actif -->
            <!-- Conteneur pour afficher les sous-titres actifs sous la vidéo -->
            <div id="current-subtitle">
                <div id="es-sub" class="sub-box"></div>
                <div id="fr-sub" class="sub-box"></div>
            </div>
        </div>
    </div>


    <script>
        const video = document.getElementById("video");
        const subtitleContainer = document.getElementById("subtitles");
        const currentSubtitleDisplay = document.getElementById("current-subtitle");
        let subtitlesData = { es: [], fr: [], eslong: [], frlong: [] };
        let activeType = "es";
        let lastActiveIndex = -1;

        const esSubDiv = document.getElementById("es-sub");
        const frSubDiv = document.getElementById("fr-sub");

        function updateActiveSubtitle() {
            if (lastActiveIndex >= 0) {
                let esSub = subtitlesData["es"][lastActiveIndex] || { text: "" };
                let frSub = findClosestSubtitle("fr", esSub.start) || { text: "" };

                if (activeType === "esfr" || activeType === "esfrlong") {
                    esSubDiv.innerText = esSub.text;
                    frSubDiv.innerText = frSub.text;
                } else {
                    esSubDiv.innerText = activeType.includes("es") ? esSub.text : "";
                    frSubDiv.innerText = activeType.includes("fr") ? frSub.text : "";
                }
            } else {
                esSubDiv.innerText = "";
                frSubDiv.innerText = "";
            }
        }

        function findClosestSubtitle(lang, time) {
            return subtitlesData[lang].reduce((closest, sub) => {
                return Math.abs(sub.start - time) < Math.abs(closest.start - time) ? sub : closest;
            }, subtitlesData[lang][0] || { text: "", start: 0 });
        }

        // Changement d'onglet pour afficher le bon sous-titre sous la vidéo
        document.querySelectorAll(".tab").forEach(tab => {
            tab.addEventListener("click", () => {
                document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
                tab.classList.add("active");
                activeType = tab.dataset.type;
                displaySubtitles(); 
                console.log("Affichage des sous-titres:", activeType);
                updateActiveSubtitle();
            });
        });

        // Chargement des sous-titres
        function loadSubtitles(type, url) {
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    subtitlesData[type] = data;
                    if (type === "es") displaySubtitles(); // Afficher les sous-titres au démarrage
                })
                .catch(error => console.error("Error loading subtitles:", error));
        }

        // Affichage de la liste des sous-titres à gauche
        function displaySubtitles() {
            subtitleContainer.innerHTML = "";
            
            let currentSubtitles = subtitlesData[activeType] || [];
            console.log("Affichage des sous-titres:", activeType, currentSubtitles);

            subtitlesData[activeType].forEach((sub, index) => {
                const div = document.createElement("div");
                div.classList.add("subtitle");
                div.innerText = sub.text;
                div.dataset.start = sub.start;
                div.dataset.index = index;
                div.onclick = () => {
                    video.currentTime = sub.start;
                    if (!video.paused) video.play();
                };
                subtitleContainer.appendChild(div);
            });
        }

        // Met à jour le sous-titre actif sous la vidéo
        function updateActiveSubtitle() {
            if (lastActiveIndex >= 0 && subtitlesData[activeType][lastActiveIndex]) {
                let sub = subtitlesData[activeType][lastActiveIndex];
                if (activeType.includes("fr")) {
                    currentSubtitleDisplay.innerText = `${sub.spanish || ""} - ${sub.french || ""}`;
                } else {
                    currentSubtitleDisplay.innerText = sub.text;
                }
            } else {
                currentSubtitleDisplay.innerText = "";
            }
        }

        // Synchronisation des sous-titres avec la vidéo
        video.addEventListener("timeupdate", () => {
            subtitlesData["es"].forEach((sub, index) => {
                const div = subtitleContainer.children[index];
                if (video.currentTime >= sub.start && video.currentTime < sub.end) {
                    div.scrollIntoView({ behavior: "smooth", block: "center" });
                    div.classList.add("active");
                    lastActiveIndex = index;
                    updateActiveSubtitle();
                } else {
                    div.classList.remove("active");
                }
            });
        });

        function playVideo() {
            video.play();
            replayingSubtitle = false;
        }

        function replaySubtitle() {
            if (!replayingSubtitle) {
                replaySubtitleIndex = lastActiveIndex;
            }
            replayingSubtitle = true;
            if (replaySubtitleIndex >= 0) {
                video.currentTime = subtitles[replaySubtitleIndex].start - 1;
                video.play();
                setTimeout(() => {
                    video.pause();
                }, ((subtitles[replaySubtitleIndex].end - subtitles[replaySubtitleIndex].start) + 2) * 1000);
            }
        }

        function prevSubtitle() {
            replayingSubtitle = false;
            if (lastActiveIndex > 0) {
                delta = subtitles[lastActiveIndex - 1].end - subtitles[lastActiveIndex - 1].start
                video.currentTime = subtitles[lastActiveIndex - 1].start + delta / 2;
                if (!video.paused) {
                    video.play();
                }
            }
        }

        function nextSubtitle() {
            replayingSubtitle = false;
            if (lastActiveIndex < subtitles.length - 1) {
                delta = subtitles[lastActiveIndex + 1].end - subtitles[lastActiveIndex + 1].start
                video.currentTime = subtitles[lastActiveIndex + 1].start + delta / 2;
                if (!video.paused) {
                    video.play();
                }
            }
        }

        loadSubtitles("es", "http://127.0.0.1:8001/subtitles_es");
        loadSubtitles("fr", "http://127.0.0.1:8001/subtitles_fr");
        loadSubtitles("eslong", "http://127.0.0.1:8001/long_subtitles_es");
        loadSubtitles("frlong", "http://127.0.0.1:8001/long_subtitles_fr");
    </script>
</body>
</html>
